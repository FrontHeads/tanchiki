# Командная работа, Git, Linear

## Порядок работы

1. Получаем задачу от лида/выбираем самостоятельно.
2. Создаем новую ветку для конкретного таска, делаем туда коммиты.
   - Ставим задаче статус In-progress.
3. Когда все готово создаем `pull request` в ветку `develop`.
   - Ставим задаче статус In-Review.
4. Проходим командное ревью.
5. Проходим ревью от Яндекса.
6. Вливаем в ветку develop (через squash & merge).
   - Ставим задаче статус Done.
7. Оповещаем всех остальных (чтобы они подтянули изменения из `develop` и сразу порешали `merge conflict`).

## Ветвление проекта

1. `main` - основная ветка в которой хранится продакшн-версия приложения.
2. `develop` - ветка в которой ведется разработка. Стабильная версия приложения из этой ветки затем мерджится с `main`.
3. `task/{номер задачи}-{описание}` - например `task/2-init-project`, временная ветка у конкретного разработчика под конкретную фичу/таск, которая по готовности фичи вливается в `develop` через `pull request`.

## ❗️ 3 важных правила

**1. Не использовать `git rebase` в уже запушенных ветках (запушенных вами или другим разработчиком)**. Это может привести к существенным конфликтам в репозитории.

**2. Пушить только в свою ветку разработки под отдельную фичу. Не пушить напрямую в develop или main.**

**3. Мерджить из `pull request` через `squash`, чтобы лишние коммиты не добавлялись в ветку разработки и в основную ветку.**

## Как правильно устанавливать зависимости?

В проекте используется `monorepo` на основе [`lerna`](https://github.com/lerna/lerna)

Заставить lerna автоматически фиксировать зависимости не получилось, поэтому при установке каждой зависимости нужно добавлять флаг `--exact`, который фиксирует версию устанавливаемой зависимости.

Чтобы добавить зависимость для клиента:

`yarn lerna add {your_dep} --scope client --exact`

Для сервера:

`yarn lerna add {your_dep} --scope server --exact`

И для клиента и для сервера:

`yarn lerna add {your_dep} --exact`

Если вы хотите добавить dev зависимость, проделайте то же самое, но с флагом `dev`:

`yarn lerna add {your_dep} --dev --scope server --exact`

## git, не очевидное

**Конфликт в package-lock.json**

Для разрешения конфликтов `package-lock.json` файла достаточно в процессе merge`а в терминале выполнить команду `npm install`, которая объединит текущие дерево зависимостей/подзависимостей с тем которое вливается. Официальная [дока npm](https://docs.npmjs.com/cli/v6/configuring-npm/package-locks#resolving-lockfile-conflicts)

**Конфликт в yarn.lock**

Этот файл формируется автоматически и пытаться разрешать в нем конфликты руками - плохая идея.

Инструкция:

1.Заканчиваем работу в ветке типа task/100500-super-task и сохраняемся (делаем коммит).

2. Чтобы на гитхаб попала версия уже без конфликтов нужно в ветку task/100500-super-task влить последние изменения из ветки develop. На гитхабе конфликты разрешать сложнее чем в IDE, а иногда это почти невозможно (как раз в случае с yarn.lock).

3. Чтобы влить последние изменения из develop в task/100500-super-task выполняем команды:

- git checkout develop - переключаемся на develop
- git pull - стягиваем последние изменения
- git checkout task/100500-super-task - переключаемся обратно на рабочую ветку
- git merge develop - вливаем код из develop в task/100500-super-task

4. Если на этом этапе вы получили сообщение о конфликте в каких-то файлах кроме yarn.lock - их можно разрешить вручную.

5. Если конфликт в yarn.lock, то в консоли нужно набрать команду `yarn`. Это автоматически исправит конфликт, после чего можно будет сделать мердж-коммит, который вольет код из develop в task/100500-super-task.
   Теперь у вас в task/100500-super-task самая актуальная версия кода + созданные вами изменения. Можно делать push, создавать pull request и быть уверенным, что на гитхабе конфликтов не будет.
