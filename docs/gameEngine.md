# Игровой движок Tanchiki (Battle City / Tank N 1990)

- [Краткое описание](#краткое-описание)
- [Классы сервисов](#классы-сервисов)
  - [Game](#game)
  - [State](#state)
  - [Resources](#resources)
  - [Loop](#loop)
  - [Zone](#zone)
  - [View](#view)
  - [IndicatorManager](#indicatormanager)
  - [AudioManager](#audiomanager)
  - [Controller](#controller)
  - [Scenario](#scenario)
  - [MapManager](#mapmanager)
  - [Statistics](#statistics)
- [Классы игровых объектов](#классы-игровых-объектов)
  - [Entity](#entity)
  - [Terrain](#terrain)
  - [Flag](#flag)
  - [EntityDynamic](#entitydynamic)
  - [Tank](#tank)
  - [TankPlayer](#tankplayer)
  - [TankEnemy](#tankenemy)
  - [Projectile](#projectile)
  - [Explosion](#explosion)
  - [Score](#score)
  - [PowerUp](#powerup)
- [Классы интерфейса](#классы-интерфейса)
  - [Overlay](#overlay)
  - [UIElement](#uielement)
  - [Screen](#screen)
- [Вспомогательные классы](#вспомогательные-классы)
  - [EventEmitter](#eventemitter)

---

## Краткое описание

В проекте используется собственная реализация игрового движка на чистом Typescript с использованием Canvas.

Архитектура построена на классах-сервисах, которые выполняют определённый набор действий над классами-объектами. Последние не обращаются к первым напрямую, а генерируют события, которые отслеживаются в сервисах, – за счёт этого снижается связность кода.

Методы и свойства классов подробно описаны в комментариях в самом коде.

---

![Game engine demo](img/GameEngineDemo1.gif)

---

## Классы сервисов

### Game

Основной сервис, в котором загружаются/выгружаются все остальные игровые сервисы. Ставит игру на паузу, запускает игровые экраны/меню.

### State

Хранит состояние игры.

### Resources

Загрузчик изображений и звуков, используемых в игре.

### Loop

Отвечает за игровой цикл (loop). Работает через window.requestAnimationFrame(), перебирая массив объектов (loopEntities), в которых отслеживаются изменения. Реализует методы setLoopDelay() и setLoopInterval() – аналоги нативных setTimeout() и setInterval(), работающие через игровой цикл (при паузе их выполнение останавливается).

### Zone

Сервис игровой зоны, который содержит матрицу (трехмерный массив 4х56х56) – карту местности, где указано расположение всех игровых объектов (танки и стены на одном слое, снаряды – на другом, лёд и деревья – на третьем, бонусы – на четвёртом). Их нужно зарегистрировать (add), чтобы данные о них автоматически обновлялись (через подписки на события). Выполняет проверку на столкновение объектов (hasCollision). Высчитывает параметры разрушения объектов.

### View

Графический сервис. Содержит несколько наложенных друг на друга канвасов (слоёв), на которых отрисовываются разные типы объектов (за счёт этого улучшается производительность, т.к. не нужно перерисовывать все сущности разом). Их нужно зарегистрировать (add), чтобы они автоматически перерисовывались при изменениях. Данный класс работает с изображениями-спрайтами объектов и реализует их анимации.

### IndicatorManager

Отвечает за отображение игровых индикаторов (название текущего уровня, остаток жизней у игрока, количество готовящихся к появлению вражеских танков).

### AudioManager

Звуковой сервис.

### Controller

Сервис управления. Ловит нажатия клавиш на клавиатуре, которые затем можно снять через соответствующие события.

### Scenario

Сервис, который отвечает за игровой сценарий, появление танков/снарядов/бонусов, их взаимодействие. Определяет победу/проигрыш на карте. Использует вспомогательные сервисы MapManager и IndicatorManager. Привязывает сервис управления (Controller) к танкам игроков.

### MapManager

Создаёт игровую карту, размещая на ней статические объекты.

### Statistics

Собирает игровую статистику для отображения на соответствующем экране после каждого игрового уровня и для отправки на сервер. Создаёт объект Score на основе Explosion для отображения в игре.

---

## Классы игровых объектов

### Entity

Абстрактная игровая сущность, от которой наследуются все остальные. Содержит общие для всех методы и свойства, связанные с жизненным циклом и позиционированием.

### Terrain

Статические сущности (стены, вода, деревья, лёд).

### Flag

Штаб, при разрушении которого игра заканчивается.

### EntityDynamic

Абстрактная игровая сущность, которая может двигаться (от неё наследуются танки и снаряды). Содержит свойства и методы, связанные с движением.

### Tank

Танк. Здесь реализована логика стрельбы и скольжения.

### TankPlayer

Танк игрока. Здесь реализована логика работы защитного поля, дающего неуязвимость.

### TankEnemy

Вражеский танк. В данном классе прописана логика поведения соответствующей сущности в игре.

### Projectile

Снаряд. Здесь просчитывается параметры урона при попадании в препятствие.

### Explosion

Взрыв. Здесь определяются параметры отображения соответствующих анимаций.

### Score

Плашка с очками, которые начисляются за уничтожение врагов или подбор бонусов.

### PowerUp

Игровые бонусы.

---

## Классы интерфейса

### Overlay

Отрисовывает игровое меню, экраны начала и завершения игры с соответствующими анимациями.

### UIElement

Элемент интерфейса (надпись, изображение, цветной прямоугольник), который отрисовывается на экране.

### Screen

Абстрактный базовый класс для экранов игры. Используется для реализации рендера экранов (главное меню, селектор уровней, игра и др.).

---

## Вспомогательные классы

### EventEmitter

От него наследуются ряд классов для реализации функционала подписок на события.
